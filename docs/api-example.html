<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API ä½¿ç”¨ç¤ºä¾‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .config {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .config label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    .config input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    .config button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .config button:hover {
      background: #0056b3;
    }
    .config button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status.loading {
      text-align: center;
      color: #666;
    }
    .status.error {
      color: #dc3545;
    }
    .monitor {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .monitor:last-child {
      border-bottom: none;
    }
    .monitor-info {
      flex: 1;
    }
    .monitor-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .monitor-url {
      color: #666;
      font-size: 12px;
    }
    .monitor-status {
      text-align: right;
      min-width: 100px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-ok {
      background: #d4edda;
      color: #155724;
    }
    .status-down {
      background: #f8d7da;
      color: #721c24;
    }
    .status-paused {
      background: #fff3cd;
      color: #856404;
    }
    .status-unknown {
      background: #e2e3e5;
      color: #383d41;
    }
    .uptime {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .last-updated {
      text-align: right;
      color: #999;
      font-size: 12px;
      margin-top: 10px;
    }
    .error-details {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
      font-size: 14px;
    }
    .error-details pre {
      background: #fff;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      overflow-x: auto;
      font-size: 12px;
    }
    .info-box {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .info-box code {
      background: rgba(255,255,255,0.5);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    .status-summary {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .summary-item {
      flex: 1;
      min-width: 120px;
      text-align: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .summary-item .label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .summary-item .value {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
    .summary-item.ok .value { color: #28a745; }
    .summary-item.down .value { color: #dc3545; }
    .summary-item.paused .value { color: #ffc107; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š æœåŠ¡çŠ¶æ€ç›‘æ§ API ç¤ºä¾‹</h1>
    
    <div class="info-box">
      <strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong>
      <ul style="margin: 10px 0 0 20px;">
        <li>è¾“å…¥æ‚¨çš„ API åœ°å€å’Œå¯†é’¥ï¼ˆå¦‚æœéœ€è¦ï¼‰</li>
        <li>ç‚¹å‡»"åŠ è½½çŠ¶æ€"æŒ‰é’®è·å–æ•°æ®</li>
        <li>ä¹Ÿå¯ä»¥é€šè¿‡ URL å‚æ•°ä¼ é€’ï¼š<code>?apiUrl=xxx&apiKey=xxx&days=30</code></li>
      </ul>
    </div>
    
    <div class="config">
      <label for="apiUrl">API åœ°å€ <span style="color: #dc3545;">*</span></label>
      <input type="text" id="apiUrl" placeholder="https://your-api.workers.dev/api/monitors" value="">
      
      <label for="apiKey">API å¯†é’¥ <span style="color: #666; font-weight: normal;">ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></label>
      <input type="password" id="apiKey" placeholder="your-api-key" value="">
      
      <label for="days">è·å–å¤©æ•°</label>
      <input type="number" id="days" placeholder="30" value="30" min="7" max="90">
      
      <button id="loadBtn" onclick="loadStatus()">ğŸ”„ åŠ è½½çŠ¶æ€</button>
    </div>
    
    <div class="status" id="statusContainer">
      <p style="text-align: center; color: #999;">ğŸ‘† è¯·è¾“å…¥ API åœ°å€å¹¶ç‚¹å‡»"åŠ è½½çŠ¶æ€"æŒ‰é’®</p>
    </div>
  </div>

  <script>
    const statusContainer = document.getElementById('statusContainer');
    const loadBtn = document.getElementById('loadBtn');
    let autoRefreshInterval = null;
    
    // ä» URL å‚æ•°åŠ è½½é…ç½®
    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      const apiUrl = params.get('apiUrl');
      const apiKey = params.get('apiKey');
      const days = params.get('days');
      
      if (apiUrl) document.getElementById('apiUrl').value = apiUrl;
      if (apiKey) document.getElementById('apiKey').value = apiKey;
      if (days) document.getElementById('days').value = days;
      
      // è‡ªåŠ¨åŠ è½½ï¼ˆå¦‚æœæœ‰ API åœ°å€ï¼‰
      if (apiUrl) {
        loadStatus();
      }
    };
    
    async function loadStatus() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const apiKey = document.getElementById('apiKey').value.trim();
      const days = parseInt(document.getElementById('days').value) || 30;
      
      // éªŒè¯è¾“å…¥
      if (!apiUrl) {
        showError('è¯·è¾“å…¥ API åœ°å€', 'API åœ°å€æ˜¯å¿…å¡«é¡¹ï¼Œè¯·å¡«å†™å®Œæ•´çš„ API ç«¯ç‚¹ URL');
        return;
      }
      
      if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        showError('API åœ°å€æ ¼å¼é”™è¯¯', 'API åœ°å€å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´');
        return;
      }
      
      // æ¸…é™¤ä¹‹å‰çš„è‡ªåŠ¨åˆ·æ–°
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
      
      loadBtn.disabled = true;
      loadBtn.textContent = 'â³ åŠ è½½ä¸­...';
      statusContainer.innerHTML = '<p class="loading">ğŸ”„ æ­£åœ¨è·å–æ•°æ®...</p>';
      
      try {
        const headers = {
          'Content-Type': 'application/json',
        };
        
        // åªæœ‰å½“ API å¯†é’¥ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ 
        if (apiKey) {
          headers['X-API-Key'] = apiKey;
        }
        
        const url = new URL(apiUrl);
        
        // æ·»åŠ æŸ¥è¯¢å‚æ•°
        if (!url.searchParams.has('days')) {
          url.searchParams.append('days', days);
        }
        
        console.log('è¯·æ±‚ URL:', url.toString());
        console.log('è¯·æ±‚å¤´:', headers);
        
        const response = await fetch(url.toString(), { 
          headers,
          method: 'GET',
        });
        
        const contentType = response.headers.get('content-type');
        console.log('å“åº”çŠ¶æ€:', response.status);
        console.log('å“åº”ç±»å‹:', contentType);
        
        let data;
        if (contentType && contentType.includes('application/json')) {
          data = await response.json();
        } else {
          const text = await response.text();
          console.log('å“åº”å†…å®¹:', text);
          throw new Error(`æœåŠ¡å™¨è¿”å›äº†é JSON å“åº”: ${response.status} ${response.statusText}`);
        }
        
        console.log('è§£æåçš„æ•°æ®:', data);
        
        if (response.ok && data.success) {
          renderMonitors(data.data, data.timestamp);
          
          // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰
          autoRefreshInterval = setInterval(() => {
            loadStatus();
          }, 300000);
        } else {
          const errorMsg = data.error || `è¯·æ±‚å¤±è´¥ (${response.status})`;
          const errorDetails = `HTTP çŠ¶æ€: ${response.status}\né”™è¯¯ä¿¡æ¯: ${errorMsg}`;
          showError(errorMsg, errorDetails, data);
        }
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        let errorDetails = '';
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorDetails = 'å¯èƒ½æ˜¯ CORS é—®é¢˜æˆ–ç½‘ç»œè¿æ¥å¤±è´¥\n\nè§£å†³æ–¹æ³•ï¼š\n1. æ£€æŸ¥ API åœ°å€æ˜¯å¦æ­£ç¡®\n2. ç¡®è®¤ API æœåŠ¡å™¨å·²é…ç½® CORS\n3. æ£€æŸ¥ç½‘ç»œè¿æ¥\n4. å°è¯•ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†é”™è¯¯';
        } else if (error.name === 'SyntaxError') {
          errorDetails = 'æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®\n\nè¯·æ£€æŸ¥ API æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ';
        } else {
          errorDetails = `é”™è¯¯ç±»å‹: ${error.name}\né”™è¯¯ä¿¡æ¯: ${error.message}`;
        }
        
        showError('è¯·æ±‚å¤±è´¥: ' + error.message, errorDetails);
      } finally {
        loadBtn.disabled = false;
        loadBtn.textContent = 'ğŸ”„ åŠ è½½çŠ¶æ€';
      }
    }
    
    function showError(message, details = null, data = null) {
      let html = `<p class="error">âŒ ${message}</p>`;
      
      if (details) {
        html += `<div class="error-details">
          <strong>è¯¦ç»†ä¿¡æ¯ï¼š</strong>
          <pre>${escapeHtml(details)}</pre>
        </div>`;
      }
      
      if (data) {
        html += `<div class="error-details">
          <strong>æœåŠ¡å™¨å“åº”ï¼š</strong>
          <pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>
        </div>`;
      }
      
      statusContainer.innerHTML = html;
    }
    
    function renderMonitors(monitors, timestamp) {
      if (!monitors || monitors.length === 0) {
        statusContainer.innerHTML = '<p style="text-align: center; color: #999;">ğŸ“­ æš‚æ— ç›‘æ§æ•°æ®</p>';
        return;
      }
      
      // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
      const stats = {
        total: monitors.length,
        ok: monitors.filter(m => m.status === 'ok').length,
        down: monitors.filter(m => m.status === 'down').length,
        paused: monitors.filter(m => m.status === 'paused').length,
        unknown: monitors.filter(m => m.status === 'unknown').length,
      };
      
      const statusMap = {
        'ok': { text: 'æ­£å¸¸', class: 'status-ok' },
        'down': { text: 'å¼‚å¸¸', class: 'status-down' },
        'paused': { text: 'æš‚åœ', class: 'status-paused' },
        'unknown': { text: 'æœªçŸ¥', class: 'status-unknown' }
      };
      
      // ç”Ÿæˆç»Ÿè®¡å¡ç‰‡
      const summaryHtml = `
        <div class="status-summary">
          <div class="summary-item">
            <div class="label">æ€»è®¡</div>
            <div class="value">${stats.total}</div>
          </div>
          <div class="summary-item ok">
            <div class="label">æ­£å¸¸</div>
            <div class="value">${stats.ok}</div>
          </div>
          <div class="summary-item down">
            <div class="label">å¼‚å¸¸</div>
            <div class="value">${stats.down}</div>
          </div>
          <div class="summary-item paused">
            <div class="label">æš‚åœ</div>
            <div class="value">${stats.paused}</div>
          </div>
        </div>
      `;
      
      // ç”Ÿæˆç›‘æ§é¡¹åˆ—è¡¨
      const monitorsHtml = monitors.map(monitor => {
        const status = statusMap[monitor.status] || statusMap['unknown'];
        return `
          <div class="monitor">
            <div class="monitor-info">
              <div class="monitor-name">${escapeHtml(monitor.name)}</div>
              <div class="monitor-url">${escapeHtml(monitor.url)}</div>
            </div>
            <div class="monitor-status">
              <span class="status-badge ${status.class}">${status.text}</span>
              <div class="uptime">å¯ç”¨ç‡: ${monitor.average.toFixed(2)}%</div>
            </div>
          </div>
        `;
      }).join('');
      
      const lastUpdated = new Date(timestamp).toLocaleString('zh-CN');
      
      statusContainer.innerHTML = `
        ${summaryHtml}
        ${monitorsHtml}
        <div class="last-updated">
          æœ€åæ›´æ–°: ${lastUpdated} | 
          <a href="#" onclick="loadStatus(); return false;" style="color: #007bff;">ç«‹å³åˆ·æ–°</a>
        </div>
      `;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
